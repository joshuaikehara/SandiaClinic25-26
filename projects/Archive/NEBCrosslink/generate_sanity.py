import numpy as np

# ==========================================
# 1. INITIAL DATA (Same as before)
# ==========================================
initial_data = [
    [1.1227429016, 2.4431889361, 6.2530843990],
    [-0.1483434901, 2.7870434770, 8.9574523640],
    [3.5246224276, 2.9381648643, 4.5124955854],
    [1.8231509420, 1.1905084756, 11.4109592041],
    [-0.4410809430, 6.2238692352, 9.7019099173],
    [6.4289045050, 1.7189325538, 6.1026433131],
    [3.8504678799, 6.3957209166, 3.8883190914],
    [-3.3233855071, 1.3356772260, 8.9059006391],
    [-4.8014913809, 1.3559350886, 10.9468613985],
    [3.0989049569, 1.2392634061, 1.4980613802],
    [4.8475817977, 1.3292143631, -0.3107087470],
    [1.9971947056, -0.8467484210, 10.9494881177],
    [0.9164982072, 1.4093765396, 13.2880429258],
    [3.7272955399, 2.0628059919, 11.4577677168],
    [-1.6127110559, 7.1583387366, 8.2362762350],
    [1.4644242576, 7.0955620393, 9.7356793207],
    [-1.3460707189, 6.4591212236, 11.5779920842],
    [6.2103387972, -0.3331020000, 6.4719146685],
    [6.7156137320, 2.7325059850, 7.9134354471],
    [8.0885941490, 2.0335341363, 4.8616980509],
    [2.1187607784, 7.1007776830, 2.9407915835],
    [5.5108378252, 6.7300134440, 2.6533453633],
    [4.1183743333, 7.4108061287, 5.7019647117],
    [-3.9831455415, 0.4534586482, 7.1762344417],
    [-4.1790723320, 2.2271554611, 12.6970878147],
    [-6.6590164386, 0.4913665516, 10.8746360713],
    [1.3904603824, 0.1465293532, 1.2141867422],
    [6.5742244335, 2.4099108615, -0.0665750466],
    [4.5570742215, 0.3072883430, -2.0600091974],
    [-0.5792388100, -3.2353053788, -4.7852208401],
    [-3.4489955936, -2.5149985237, -4.2553983647],
    [0.3696870951, -1.7192916017, -7.2052417356],
    [2.5844459538, -1.1966878795, -9.1751865924],
    [-5.6496193018, -2.3053712198, -2.2174233723],
    [-4.9743068225, 0.3537000133, 0.0004724315],
    [-5.8980804748, -5.3327311508, -0.4237521557],
    [-0.3397349382, -6.7091886636, -5.3486048491],
    [0.9490014942, -2.5124473936, -2.5920993440],
    [4.7497884778, -3.9785535074, -9.3300685345],
    [4.4027025055, 1.6649430823, -8.2038485370],
    [1.1823637565, -0.6611584316, -12.3655542872],
    [-8.6982953420, -1.6950464173, -3.8816294614],
    [-3.1753632704, -0.0161382599, 1.0064491643],
    [-6.5298725646, 0.5105472703, 1.3966775809],
    [-4.8189902435, 2.1431571409, -1.0801673751],
    [-4.0876851832, -5.7077472732, 0.5643666665],
    [-6.3063368774, -6.9006557008, -1.7539491763],
    [-7.4459739293, -5.1853892155, 0.9822984661],
    [1.6600486919, -7.2275782968, -5.6990356364],
    [-1.5029557705, -7.2313577488, -7.0120928423],
    [-1.0352107938, -7.7350264165, -3.6577347263],
    [5.5868426045, -4.3183451374, -7.4383583336],
    [6.2783122410, -3.5952981796, -10.7124219924],
    [3.6711139863, -5.6709354110, -9.9351021042],
    [5.2733937547, 1.3423857533, -6.3289002057],
    [3.1121708334, 3.3137668018, -8.1046568199],
    [5.9121022416, 2.0403560472, -9.6088220151],
    [0.1059002444, -2.3620818967, -12.9502544054],
    [2.7146480744, -0.2917170009, -13.7476431835],
    [-0.1054089156, 0.9913880481, -12.2914392340],
    [-8.5575107558, 0.0974720665, -4.9595291653],
    [-10.2454707006, -1.5464194683, -2.4752008944],
    [-9.1009203611, -3.2736668164, -5.2010361466]
]

# ==========================================
# 2. SCRAMBLED FINAL DATA (Same as before)
# ==========================================
final_data_scrambled = [
    [0.8606190097, 1.1888077222, 4.4954880515],
    [-0.7380135876, 1.6605967125, 7.0159100888],
    [3.5402126670, 1.7531554914, 3.2348518445],
    [0.7965384015, 0.0330135130, 9.7543876080],
    [-0.8661181124, 5.1294722235, 7.6832479244],
    [5.9918675756, 1.5642584816, 5.7681618131],
    [3.6070333780, 5.0354205610, 1.9632174323],
    [-3.9841093018, 0.4264544638, 6.6902914037],
    [-5.6380352815, 0.6505570688, 8.5814724814],
    [4.5987993713, -0.6449823772, 0.8259992296],
    [3.4600126961, -0.6228914804, -1.8388356677],
    [0.8955411460, -2.0267500200, 9.3833966019],
    [-0.3290012946, 0.3776239443, 11.4891371682],
    [2.7274982111, 0.7843874633, 10.0496006019],
    [-1.7990002439, 6.1277010797, 6.0960481694],
    [1.0829074778, 5.8651047563, 7.9182731457],
    [-1.9467201244, 5.4670906686, 9.4474772101],
    [5.9944753975, -0.3633943076, 6.5928571318],
    [5.5787167827, 2.9775656512, 7.2583052414],
    [7.8753007767, 1.9676582884, 4.9415200766],
    [2.1507538394, 5.2353724679, 0.4871902571],
    [5.4997451337, 5.4421462855, 1.1611988255],
    [3.1992683042, 6.3874439168, 3.5121124416],
    [-4.5409359616, -0.4907996338, 4.9451105560],
    [-5.1156961210, 1.5623498583, 10.3459852259],
    [-7.5415562698, -0.0812582175, 8.3783647321],
    [4.4932392776, -2.5678541596, 1.6576676372],
    [3.6235495831, 1.2654172137, -2.7400459917],
    [4.6481401169, -1.9539010832, -2.9406215081],
    [0.1832845236, -1.9156341319, -2.2624555426],
    [-1.9182230565, 0.1014404911, -1.4917685927],
    [-0.1181078743, -2.6680096370, -5.1699312569],
    [0.9584879187, -4.4297822789, -7.3844822457],
    [-3.5091455718, 2.5474073244, -2.2304057898],
    [-1.5717040020, 4.7442704779, -4.2013333042],
    [-4.4947321611, 4.1461533053, 0.7485393613],
    [-0.2799062134, -4.8190469353, -0.3137134114],
    [1.8330153117, -7.5986448919, -6.0940261626],
    [3.8313816474, -2.9797388361, -8.8394767706],
    [-1.4870253804, -4.8923683037, -9.8824543382],
    [-6.3849494785, 1.6765271026, -4.0849072860],
    [0.1642927774, 5.2990751309, -3.1865693455],
    [-2.6959775816, 6.4610109495, -4.6294507269],
    [-1.0423728553, 3.7904312852, -5.9904313839],
    [-2.7884418743, 4.6439071307, 1.8542180373],
    [-5.6967868625, 2.8388975582, 1.8613800988],
    [-5.5831954333, 5.8792210094, 0.3030742541],
    [1.1871069688, -6.2354154610, -0.7864661619],
    [-2.1782304553, -5.6190624326, -0.7030536568],
    [-0.1328288397, -4.3229938633, 1.7164948072],
    [3.3355931370, -7.3762619376, -4.6500298429],
    [2.5503930915, -8.8120946410, -7.6462848841],
    [0.1473797299, -8.4965481954, -5.2303835912],
    [5.3239439249, -2.7466033409, -7.3884506702],
    [3.3467236231, -1.1126139703, -9.6567265689],
    [4.5469641875, -4.2401104814, -10.3562464381],
    [-3.1857945579, -5.7905739633, -9.0469686841],
    [-0.7093086498, -6.1383213397, -11.3811771225],
    [-2.0007662877, -3.0405880129, -10.7175431498],
    [-5.8122113259, 0.7497298887, -5.8760273725],
    [-7.4684805658, 3.4184198271, -4.5257614619],
    [-7.5884970634, 0.3749783279, -2.9682304048],
    [6.6300091447, -0.1894072358, 0.5593966871]
]

# ==========================================
# 3. ATOM TYPES 
# ==========================================
atom_types = [
    "O", "Si", "Si", "C", "C", "C", "C", "C", "C", "C", 
    "C", "H", "H", "H", "H", "H", "H", "H", "H", "H", 
    "H", "H", "H", "H", "H", "H", "H", "H", "H", "Si", 
    "O", "O", "Si", "Si", "C", "C", "C", "H", "C", "C", 
    "C", "C", "H", "H", "H", "H", "H", "H", "H", "H", 
    "H", "H", "H", "H", "H", "H", "H", "H", "H", "H", 
    "H", "H", "H"
]

def generate_sanity_xyz():
    initial = np.array(initial_data)
    final_scrambled = np.array(final_data_scrambled)
    used_indices = set()
    
    # This array will hold the reordered final coordinates
    final_reordered = np.zeros_like(initial)

    # --- Step 1: Re-order ---
    for i, target_pos in enumerate(initial):
        best_dist = float('inf')
        best_idx = -1
        
        for j, candidate_pos in enumerate(final_scrambled):
            if j in used_indices:
                continue
            dist = np.linalg.norm(target_pos - candidate_pos)
            if dist < best_dist:
                best_dist = dist
                best_idx = j
        
        used_indices.add(best_idx)
        final_reordered[i] = final_scrambled[best_idx]

    # --- Step 2: Calculate Midpoint (Sanity Check) ---
    # Midpoint = (Initial + Final) / 2
    midpoints = (initial + final_reordered) / 2.0

    # --- Step 3: Output to .XYZ file ---
    with open("midpoint_check.xyz", "w") as f:
        f.write(f"{len(atom_types)}\n")
        f.write("Sanity Check: Linear Interpolation Midpoint\n")
        
        for i in range(len(atom_types)):
            # XYZ format: Element X Y Z
            f.write(f"{atom_types[i]} {midpoints[i][0]:.6f} {midpoints[i][1]:.6f} {midpoints[i][2]:.6f}\n")

    print("Done. Generated 'midpoint_check.xyz'.")
    print("Please load this file into VMD, Avogadro, or Ovito.")
    print("If the molecule looks 'exploded' or atoms are touching, the re-ordering failed.")

if __name__ == "__main__":
    generate_sanity_xyz()